<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的主页</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- iOS 设计系统 --- */
        :root {
            --ios-bg-glass: rgba(30, 30, 30, 0.60);
            --ios-border: rgba(255, 255, 255, 0.12);
        }
        body { margin: 0; font-family: -apple-system, "PingFang SC", sans-serif; overflow: hidden; background: #000; color: white; -webkit-font-smoothing: antialiased; }
        
        .bg-layer { position: fixed; inset: 0; z-index: -1; background-size: cover; background-position: center; transition: background 1.2s ease; }
        
        /* 毛玻璃卡片 */
        .ios-glass {
            background: var(--ios-bg-glass);
            backdrop-filter: blur(40px) saturate(160%); -webkit-backdrop-filter: blur(40px) saturate(160%);
            border: 1px solid var(--ios-border); border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* --- 核心升级：APP 图标样式 --- */
        .app-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 24px; width: 100%; max-width: 800px; padding: 10px; }
        
        .app-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            width: 72px; cursor: pointer; transition: all 0.2s;
            text-decoration: none; color: white;
        }
        .app-item:hover { transform: scale(1.05); }
        .app-item:active { transform: scale(0.95); opacity: 0.8; }
        
        .app-icon-box {
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px; /* iOS 连续曲率圆角风格 */
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .app-img { width: 100%; height: 100%; object-fit: cover; }
        /* 如果加载失败，显示这个默认样式 */
        .app-img-fallback { width: 30px; height: 30px; opacity: 0.8; }
        
        .app-name {
            font-size: 12px; font-weight: 500; text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            width: 120%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 搜索框 */
        .ios-search-bar {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50px;
            transition: all 0.3s;
        }
        .ios-search-bar:focus-within { background: rgba(255, 255, 255, 0.25); border-color: #fff; box-shadow: 0 0 0 4px rgba(255,255,255,0.1); }
        .search-input { background: transparent; border: none; outline: none; color: white; width: 100%; font-size: 16px; height: 100%; text-align: center; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.6); }

        /* 通用 UI */
        .ios-input { background: rgba(118, 118, 128, 0.24); border: none; padding: 12px; border-radius: 12px; width: 100%; color: white; outline: none; font-size: 14px; }
        .ios-btn { background: #007AFF; color: white; padding: 8px 16px; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px; font-size: 14px; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        
        /* 拖拽相关 */
        .sortable-ghost { opacity: 0.5; filter: grayscale(100%); }
        
        /* 股市与效率中心样式保持不变 */
        .tv-widget { filter: invert(1) hue-rotate(180deg) contrast(0.85) brightness(1.1); mix-blend-mode: screen; opacity: 0.9; }
        .tab-btn { flex: 1; text-align: center; padding: 8px; font-size: 13px; color: rgba(255,255,255,0.6); cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: rgba(99, 99, 102, 0.5); color: white; font-weight: 600; }
        .todo-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 6px; }
        .todo-item.done span { text-decoration: line-through; opacity: 0.4; }
    </style>
</head>
<body>

    <div id="mainBg" class="bg-layer" style="background-image: url('https://bing.biturl.top/?resolution=1920&format=image&index=0&mkt=zh-CN');"></div>

    <div class="relative h-screen w-full flex flex-col p-6 overflow-y-auto scroll-hide items-center">
        
        <div class="flex flex-col items-center mt-8 mb-6 z-10">
            <h1 id="clock" class="text-7xl font-bold tracking-tight drop-shadow-2xl mb-2">00:00</h1>
            <p id="date" class="text-base font-medium opacity-80 uppercase tracking-widest">Loading...</p>
        </div>

        <div class="w-full max-w-md mb-10 z-10 relative">
            <div class="ios-search-bar flex items-center px-5 py-3.5">
                <input type="text" id="searchInput" class="search-input" placeholder="Search" autocomplete="off">
            </div>
        </div>

        <div id="shortcutsDisplay" class="app-grid mb-10 z-10">
            </div>

        <div id="widgetGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 w-full max-w-[1400px] flex-1 mb-8">
            <div data-id="stock" id="widget-stock" class="lg:col-span-2 ios-glass p-1 h-[360px] overflow-hidden relative">
                <div class="tradingview-widget-container w-full h-full tv-widget pointer-events-none">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                    { "colorTheme": "light", "dateRange": "12M", "showChart": true, "locale": "zh_CN", "width": "100%", "height": "100%", "isTransparent": true,
                      "tabs": [ { "title": "全球", "symbols": [ { "s": "NASDAQ:NDX" }, { "s": "S&P:SPX" }, { "s": "TVC:NI225" }, { "s": "TVC:UKX" } ] } ] }
                    </script>
                </div>
            </div>

            <div data-id="news" id="widget-news" class="ios-glass p-5 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-white/10">
                    <span class="text-xs font-bold text-[#007AFF] uppercase tracking-wider">NEWS</span>
                    <span id="newsSourceLabel" class="text-[10px] bg-white/10 px-2 py-0.5 rounded opacity-60">BAIDU</span>
                </div>
                <div id="newsList" class="space-y-2 overflow-y-auto scroll-hide flex-1 text-sm"></div>
            </div>

            <div data-id="hub" id="widget-hub" class="ios-glass p-4 h-[360px] flex flex-col">
                <div class="flex bg-[rgba(118,118,128,0.24)] p-1 rounded-lg mb-3">
                    <div class="tab-btn active" onclick="switchTab('note')">笔记</div>
                    <div class="tab-btn" onclick="switchTab('todo')">待办</div>
                </div>
                <div id="tab-note" class="flex-1 flex flex-col h-full">
                    <textarea id="noteArea" class="w-full flex-1 bg-transparent border-none outline-none text-sm resize-none" placeholder="随手记..."></textarea>
                </div>
                <div id="tab-todo" class="flex-1 flex flex-col h-full hidden">
                    <div class="flex gap-2 mb-2">
                        <input id="todoInput" type="text" class="ios-input py-1.5 text-sm" placeholder="新任务..." onkeypress="if(event.key==='Enter') addTodo()">
                    </div>
                    <div id="todoList" class="flex-1 overflow-y-auto scroll-hide text-sm"></div>
                </div>
            </div>
        </div>

        <button onclick="toggleSettings(true)" class="fixed bottom-6 right-6 w-10 h-10 flex items-center justify-center ios-glass hover:bg-white/20 rounded-full z-40">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
        </button>
    </div>

    <div id="settingsPanel" class="fixed inset-y-0 right-0 w-full md:w-[350px] bg-[#1c1c1e] z-50 translate-x-full transition-transform duration-300 p-6 overflow-y-auto shadow-2xl border-l border-white/10 text-sm">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">设置</h2>
            <button onclick="toggleSettings(false)" class="text-2xl opacity-50">&times;</button>
        </div>

        <div class="space-y-6">
            <section><h3 class="font-bold opacity-50 mb-2 uppercase text-xs">搜索引擎</h3><select id="searchEngineSelect" class="ios-input"><option value="google">Google</option><option value="baidu">百度</option><option value="bing">Bing</option></select></section>
            
            <section><h3 class="font-bold opacity-50 mb-2 uppercase text-xs">快捷方式 (APP图标)</h3>
                <div id="shortcutList" class="space-y-2 mb-3 max-h-40 overflow-y-auto bg-white/5 rounded-xl p-2"></div>
                <div class="flex gap-2"><input id="newSiteName" type="text" placeholder="名称" class="ios-input"><input id="newSiteUrl" type="text" placeholder="网址" class="ios-input"></div>
                <button onclick="addShortcut()" class="ios-btn">添加</button>
            </section>
            
            <section><h3 class="font-bold opacity-50 mb-2 uppercase text-xs">其他设置</h3>
                <input id="cityInput" type="text" class="ios-input mb-2" placeholder="城市拼音">
                <select id="newsSourceSelect" class="ios-input"><option value="baidu">百度热搜</option><option value="weibo">微博热搜</option></select>
            </section>
            
            <button onclick="saveAll()" class="ios-btn bg-green-600">保存并应用</button>
        </div>
    </div>

    <script>
        let config = {
            searchEngine: 'baidu', widgets: { stock: true, news: true, hub: true },
            newsSource: 'baidu', city: 'Shanghai',
            shortcuts: [ { name: 'Bilibili', url: 'https://www.bilibili.com' }, { name: 'GitHub', url: 'https://github.com' }, { name: 'ChatGPT', url: 'https://chat.openai.com' }, { name: '淘宝', url: 'https://www.taobao.com' } ],
            todos: [], widgetOrder: ['stock', 'news', 'hub']
        };
        const engines = { google: "https://www.google.com/search?q=", baidu: "https://www.baidu.com/s?wd=", bing: "https://www.bing.com/search?q=" };

        // 获取 Logo 的核心函数
        function getFavicon(url) {
            try {
                const domain = new URL(url).hostname;
                // 使用 Google 服务获取高清图标 (无需翻墙通常可用，如果不行会自动显示 fallback)
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            } catch(e) { return ''; }
        }

        function init() {
            const saved = localStorage.getItem('idash_icon_v1');
            if (saved) { const p = JSON.parse(saved); config = { ...config, ...p, widgets: { ...config.widgets, ...(p.widgets || {}) }, todos: p.todos || [] }; }
            
            // 拖拽初始化
            new Sortable(document.getElementById('widgetGrid'), {
                animation: 200, handle: '.ios-glass', draggable: '[data-id]',
                onEnd: function (evt) { config.widgetOrder = Array.from(document.getElementById('widgetGrid').children).map(el => el.getAttribute('data-id')).filter(id => id); saveConfigOnly(); }
            });
            // 拖拽APP图标
            new Sortable(document.getElementById('shortcutsDisplay'), {
                animation: 200,
                onEnd: function(evt) {
                     // 重新获取顺序
                     const newOrder = [];
                     document.querySelectorAll('.app-item').forEach(item => {
                         newOrder.push({ name: item.dataset.name, url: item.dataset.url });
                     });
                     config.shortcuts = newOrder;
                     saveConfigOnly();
                }
            });

            if (config.widgetOrder) config.widgetOrder.forEach(id => { const el = document.querySelector(`[data-id="${id}"]`); if (el) document.getElementById('widgetGrid').appendChild(el); });

            applyUI();
            startServices();
            renderTodos();
            
            const note = document.getElementById('noteArea');
            note.value = localStorage.getItem('idash_note') || '';
            note.addEventListener('input', e => localStorage.setItem('idash_note', e.target.value));

            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if(e.key==='Enter' && e.target.value.trim()) { window.open((engines[config.searchEngine]||engines.baidu) + encodeURIComponent(e.target.value), '_blank'); e.target.value=''; }
            });
        }

        function applyUI() {
            document.getElementById('cityInput').value = config.city;
            document.getElementById('newsSourceSelect').value = config.newsSource;
            document.getElementById('searchEngineSelect').value = config.searchEngine;
            
            // 渲染 APP 图标 (核心修改)
            const scContainer = document.getElementById('shortcutsDisplay');
            scContainer.innerHTML = config.shortcuts.map(s => `
                <a href="${s.url}" target="_blank" class="app-item" data-name="${s.name}" data-url="${s.url}">
                    <div class="app-icon-box">
                        <img src="${getFavicon(s.url)}" class="app-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/106/106752.png';this.style.opacity='0.5'">
                    </div>
                    <span class="app-name">${s.name}</span>
                </a>
            `).join('');

            renderShortcutListSettings();
            renderNews();
        }

        function renderShortcutListSettings() {
             document.getElementById('shortcutList').innerHTML = config.shortcuts.map((s, idx) => `
                <div class="flex justify-between items-center p-2 bg-white/5 rounded">
                    <img src="${getFavicon(s.url)}" class="w-4 h-4 rounded-sm mr-2">
                    <span class="truncate flex-1 text-xs opacity-80">${s.name}</span>
                    <button onclick="removeShortcut(${idx})" class="text-red-400 text-xs">✕</button>
                </div>
            `).join('');
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#widget-hub > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
            if(t==='note') document.querySelectorAll('.tab-btn')[0].classList.add('active');
            if(t==='todo') document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById(`tab-${t}`).classList.remove('hidden');
        }

        function renderTodos() {
            const l = document.getElementById('todoList');
            l.innerHTML = config.todos.length===0 ? '<div class="text-center opacity-30 mt-5">无待办</div>' : config.todos.map((t, i) => `
                <div class="todo-item ${t.done?'done':''}">
                    <div class="w-4 h-4 border border-white/50 rounded cursor-pointer flex items-center justify-center" onclick="toggleTodo(${i})">${t.done?'✓':''}</div>
                    <span class="flex-1 cursor-text">${t.text}</span>
                    <span class="opacity-50 cursor-pointer" onclick="deleteTodo(${i})">✕</span>
                </div>`).join('');
        }
        function addTodo() { const v=document.getElementById('todoInput').value.trim(); if(v){config.todos.push({text:v,done:false});document.getElementById('todoInput').value='';saveConfigOnly();renderTodos();} }
        function toggleTodo(i){ config.todos[i].done=!config.todos[i].done; saveConfigOnly(); renderTodos(); }
        function deleteTodo(i){ config.todos.splice(i,1); saveConfigOnly(); renderTodos(); }

        function saveConfigOnly() { localStorage.setItem('idash_icon_v1', JSON.stringify(config)); }
        function saveAll() {
            config.city = document.getElementById('cityInput').value;
            config.newsSource = document.getElementById('newsSourceSelect').value;
            config.searchEngine = document.getElementById('searchEngineSelect').value;
            saveConfigOnly(); location.reload();
        }

        function addShortcut() { const n=document.getElementById('newSiteName').value.trim(); const u=document.getElementById('newSiteUrl').value.trim(); if(n&&u){ config.shortcuts.push({name:n,url:u}); saveAll(); } }
        function removeShortcut(i) { config.shortcuts.splice(i,1); saveAll(); }

        function startServices() {
            setInterval(() => { const n=new Date(); document.getElementById('clock').innerText=n.toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'}); document.getElementById('date').innerText=`${n.getMonth()+1}月${n.getDate()}日 星期${"日一二三四五六"[n.getDay()]}`; }, 1000);
            renderNews();
        }
        
        function renderNews() {
             const data = { 'baidu': ["科技前沿动态速递", "全球市场最新收盘情况", "新一代人工智能发布", "周末出行天气指南"], 'weibo': ["今日热搜话题榜", "数码圈最新爆料", "生活小技巧分享"] }[config.newsSource] || [];
             document.getElementById('newsList').innerHTML = data.map((t,i)=>`<div class="py-2 border-b border-white/5 truncate opacity-80 hover:opacity-100 cursor-pointer"><span class="text-blue-400 mr-2">${i+1}.</span>${t}</div>`).join('');
        }

        function toggleSettings(s) { document.getElementById('settingsPanel').classList.toggle('translate-x-full', !s); }

        window.onload = init;
    </script>
</body>
</html>
